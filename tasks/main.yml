#SPDX-License-Identifier: MIT-0
---
# tasks file for ansible-role-gatus
- name: Ensure image is pulled
  containers.podman.podman_image:
    name: "{{ gatus_image }}"
    tag: "{{ gatus_image_tag }}"
  register: pulled
  become_user: "{{ rootless_user }}"

- name: Remove existing container if image has changed
  containers.podman.podman_container:
    name: "{{ gatus_container }}"
    state: absent
  when: pulled.changed
  become_user: "{{ rootless_user }}"

- name: Ensure /etc/gatus/ directory exists
  file:
    path: /etc/gatus
    state: directory
    owner: "{{ rootless_user }}"
    group: "{{ rootless_user }}"
    mode: '0755'
  become: true

- name: Copy template to host 
  template:
    src: templates/config.yml.j2
    dest: /etc/gatus/config.yml
    owner: "{{ rootless_user }}"
    group: "{{ rootless_user }}"
    mode: '0444'
    force: yes
  become: true

- name: Create Gatus quadlet
  containers.podman.podman_container:
    name: "{{ gatus_container }}"
    image: "{{ gatus_image }}"
    state: quadlet
    quadlet_filename: "quadlet-gatus"
    quadlet_file_mode: '0640'
    ports:
      - "8080:8080"
    volumes:
      - "/etc/gatus/config.yml:/config/config.yaml"
    quadlet_options:
      - "AutoUpdate=registry"
      - "Pull=newer"
      - |
        [Install]
        WantedBy=default.target
  become_user: "{{ rootless_user }}"
